{% extends 'base/users.html' %}

{% block title %}Messages | RentEase{% endblock %}

{% block extra_head %}
<style>
  .container {
    max-width: calc(100vw - 2rem) !important;
    margin: 0 1rem !important;
    padding: 1rem 0 5rem 0 !important;
  }
  .profile-pic-sm {
    width: 48px;
    height: 48px;
    object-fit: cover;
    border-radius: 50%;
    margin-right: 12px;
    vertical-align: middle;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #ccc;
    background: #eee;
    aspect-ratio: 1/1;
    display: inline-block;
  }
  .chat-message {
    display: flex;
    align-items: flex-end;
    margin-bottom: 16px;
    max-width: 90%;
  }
  .chat-message.left {
    flex-direction: row;
    justify-content: flex-start;
    margin-right: auto;
    text-align: left;
  }
  .chat-message.right {
    flex-direction: row-reverse;
    justify-content: flex-end;
    margin-left: auto;
    text-align: right;
  }
  .chat-message.left .chat-bubble {
    background: #d1e7dd;
    border: 2px solid #bcd0c7;
  }
  .chat-message.right .chat-bubble {
    background: #f1f0f0;
  }
  .chat-bubble {
    border-radius: 16px;
    padding: 10px 18px;
    margin: 0 8px;
    min-width: 60px;
    max-width: 100%;
    word-break: break-word;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    font-size: 1.05em;
    display: inline-block;
  }
  .chat-bubble img {
    max-width: 200px;
    max-height: 200px;
    border-radius: 12px;
    margin-top: 6px;
    display: block;
  }
  .chat-meta {
    font-size: 0.8em;
    color: #888;
    margin-top: 2px;
  }
  .attach-btn {
    border: none;
    background: none;
    font-size: 1.5em;
    color: #0d6efd;
    margin-right: 8px;
    cursor: pointer;
    transition: color 0.2s;
  }
  .attach-btn:hover {
    color: #084298;
  }
  #fileInput {
    display: none;
  }
</style>
{% endblock %}

{% block content %}
<h2>Messages</h2>
<div class="row">
  <div class="col-md-4">
    <div class="list-group">
      <div class="list-group-item active">Conversations</div>
      {% for convo in conversations %}
        <a href="{{ url_for('messages', user=convo.id) }}" class="list-group-item list-group-item-action {% if other_user and other_user.id == convo.id %}active{% endif %}">
          <img src="{% if convo.profile_pic %}{{ url_for('uploaded_file', filename=convo.profile_pic) }}{% else %}{{ url_for('static', filename='images/default_profile.png') }}{% endif %}" alt="Profile" class="profile-pic-sm" onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/default_profile.png') }}';">
          {{ convo.name }}
        </a>
      {% else %}
        <div class="list-group-item">No conversations yet.</div>
      {% endfor %}
    </div>
  </div>
  <div class="col-md-8">
    {% if other_user %}
      <div class="card shadow-sm mb-3">
        <div class="card-header">
          <img src="{% if other_user.profile_pic %}{{ url_for('uploaded_file', filename=other_user.profile_pic) }}{% else %}{{ url_for('static', filename='images/default_profile.png') }}{% endif %}" alt="Profile" class="profile-pic-sm" onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/default_profile.png') }}';">
          <strong>Chat with {{ other_user.name }}</strong>
        </div>
        <div class="card-body" style="height:300px; overflow-y:auto;" id="chatMessages">
          {% for msg in messages_history %}
            <div class="chat-message {% if msg.sender_id == user.id %}left{% else %}right{% endif %}">
              <img src="{% if msg.sender_id == user.id %}
                          {% if user.profile_pic %}{{ url_for('uploaded_file', filename=user.profile_pic) }}{% else %}{{ url_for('static', filename='images/default_profile.png') }}{% endif %}
                        {% else %}
                          {% if msg.sender_profile_pic %}{{ url_for('uploaded_file', filename=msg.sender_profile_pic) }}{% else %}{{ url_for('static', filename='images/default_profile.png') }}{% endif %}
                        {% endif %}"
                   alt="Profile" class="profile-pic-sm"
                   onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/default_profile.png') }}';">
              <div>
                <div class="chat-bubble">
                  <b>
                    {% if msg.sender_id == user.id %}
                      You
                    {% else %}
                      {{ msg.sender_name }}
                    {% endif %}
                  </b><br>
                  {{ msg.content|safe }}
                  {% if msg.attachment_url %}
                    <img src="{{ url_for('uploaded_file', filename=msg.attachment_url) }}" alt="Attachment">
                  {% endif %}
                </div>
                <div class="chat-meta">{{ msg.timestamp.strftime('%Y-%m-%d %H:%M') }}</div>
              </div>
            </div>
          {% endfor %}
        </div>
        <div class="card-footer">
          <div class="input-group">
            <button class="attach-btn" id="attachBtn" title="Attach file/image">
              <i class="fas fa-paperclip"></i>
            </button>
            <input type="file" id="fileInput" accept="image/*">
            <input type="text" id="chatInput" class="form-control" placeholder="Type your message...">
            <button class="btn btn-primary" id="sendMsgBtn">Send</button>
          </div>
          <div id="filePreview" style="margin-top:8px;"></div>
        </div>
      </div>
    {% else %}
      <div class="alert alert-info">Select a conversation to start chatting.</div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- FontAwesome for paperclip icon -->
<script src="https://kit.fontawesome.com/4e5b7e8e8b.js" crossorigin="anonymous"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const userId = {{ user.id|tojson }};
const otherId = {% if other_user %}{{ other_user.id|tojson }}{% else %}null{% endif %};
const otherName = {% if other_user %}{{ other_user.name|tojson }}{% else %}null{% endif %};
const userProfilePic = "{% if user.profile_pic %}{{ url_for('uploaded_file', filename=user.profile_pic) }}{% else %}{{ url_for('static', filename='images/default_profile.png') }}{% endif %}";
const defaultProfilePic = "{{ url_for('static', filename='images/default_profile.png') }}";
const room = (otherId !== null) ? `chat_${Math.min(userId, otherId)}_${Math.max(userId, otherId)}` : null;
let socket;
let selectedFile = null;

function scrollChatToBottom() {
  const chatMessages = document.getElementById('chatMessages');
  if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
}
scrollChatToBottom();

// Attach button logic
document.getElementById('attachBtn')?.addEventListener('click', function() {
  document.getElementById('fileInput').click();
});
document.getElementById('fileInput')?.addEventListener('change', function() {
  const preview = document.getElementById('filePreview');
  preview.innerHTML = '';
  selectedFile = this.files[0] || null;
  if (selectedFile) {
    if (selectedFile.type.startsWith('image/')) {
      const img = document.createElement('img');
      img.src = URL.createObjectURL(selectedFile);
      img.style.maxWidth = '80px';
      img.style.maxHeight = '80px';
      img.style.borderRadius = '8px';
      img.style.marginRight = '4px';
      preview.appendChild(img);
    } else {
      preview.textContent = selectedFile.name;
    }
  }
});

if (room) {
  socket = io();
  socket.emit('join_room', { room: room });

  socket.on('receive_message', function(data) {
    if (data.sender_id == userId || data.sender_id == otherId) {
      const chatMessages = document.getElementById('chatMessages');
      let isMe = data.sender_id == userId;
      let align = isMe ? 'left' : 'right';
      let imgSrc = isMe
        ? userProfilePic
        : (data.sender_profile_pic ? `/uploads/${data.sender_profile_pic}` : defaultProfilePic);
      let senderName = isMe ? 'You' : data.sender_name;
      let attachmentHtml = '';
      if (data.attachment_url) {
        attachmentHtml = `<img src="/uploads/${data.attachment_url}" alt="Attachment">`;
      }
      chatMessages.innerHTML += `
        <div class="chat-message ${align}">
          <img src="${imgSrc}" alt="Profile" class="profile-pic-sm" style="width:48px;height:48px;margin-right:12px;" onerror="this.onerror=null;this.src='${defaultProfilePic}';">
          <div>
            <div class="chat-bubble">
              <b>${senderName}</b><br>
              ${data.content}
              ${attachmentHtml}
            </div>
            <div class="chat-meta">${data.timestamp}</div>
          </div>
        </div>
      `;
      scrollChatToBottom();
    }
  });

  document.getElementById('sendMsgBtn').addEventListener('click', function() {
    sendMessage();
  });

  document.getElementById('chatInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') sendMessage();
  });

  function sendMessage() {
    const input = document.getElementById('chatInput');
    const msg = input.value.trim();
    // If there is a file or text, send
    if ((msg || selectedFile) && socket) {
      if (selectedFile) {
        // Upload file first
        const formData = new FormData();
        formData.append('file', selectedFile);
        fetch('/upload_message_file', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success && data.file_url) {
            socket.emit('send_message', {
              sender_id: userId,
              receiver_id: otherId,
              content: msg,
              room: room,
              attachment_url: data.file_url
            });
          }
        });
      } else {
        socket.emit('send_message', {
          sender_id: userId,
          receiver_id: otherId,
          content: msg,
          room: room
        });
      }
      input.value = '';
      document.getElementById('fileInput').value = '';
      document.getElementById('filePreview').innerHTML = '';
      selectedFile = null;
    }
  }
}
</script>
{% endblock %}