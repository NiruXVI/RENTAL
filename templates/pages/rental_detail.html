{% extends 'base/users.html' %}

{% block title %}Rental Detail | RentEase{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  .container {
    max-width: calc(100vw - 2rem) !important;
    margin: 0 1rem !important;
    padding: 1rem 0 5rem 0 !important;
  }
  .property-image-thumb {
    width: 160px;
    height: 120px;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid #ddd;
    margin: 0.25rem;
    cursor: zoom-in;
    transition: box-shadow 0.2s;
  }
  .zoom-modal {
    display: none;
    position: fixed;
    z-index: 1050;
    left: 0; top: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.7);
    align-items: center; justify-content: center;
  }
  .zoom-modal img {
    max-width: 90vw;
    max-height: 80vh;
    border-radius: 10px;
    box-shadow: 0 0 20px #000;
  }
  .zoom-modal.active { display: flex; }
  #property-map {
    width: 100%;
    height: 320px;
    border-radius: 8px;
    margin-bottom: 1rem;
    border: 1px solid #ddd;
  }
</style>
{% endblock %}

{% block content %}
<h2>{{ property.title if property else ('Rental Property #' ~ rental_id) }}</h2>

<!-- Property Images with Zoom -->
<div class="mb-3">
  {% if property.images and property.images|length > 0 %}
    {% for img in property.images %}
      <img src="{{ url_for('uploaded_file', filename=img.image_file) }}" class="property-image-thumb" alt="Property Image" onclick="openZoom('{{ url_for('uploaded_file', filename=img.image_file) }}')">
    {% endfor %}
  {% else %}
    <img src="/static/images/sample1.jpg" class="property-image-thumb" alt="Property Image">
  {% endif %}
</div>

<!-- Zoom Modal -->
<div id="zoomModal" class="zoom-modal" onclick="closeZoom()">
  <img id="zoomImg" src="" alt="Zoomed Image">
</div>

<!-- Property Location Map -->
{% if property.location and property.location.latitude and property.location.longitude %}
  <div id="property-map"></div>
{% endif %}

<p>{{ property.description if property else 'Description of property…' }}</p>
<p><strong>Price:</strong> {{ property.price if property else '₱10,000/month' }}</p>
<p><strong>Address:</strong> {{ property.address }}</p>

<a href="#" class="btn btn-success btn-lg">Rent Now!</a>

{% if session['role'] == 'tenant' and session['user_id'] != landlord.id %}
  <button class="btn btn-primary mt-3" id="messageLandlordBtn">Message Landlord</button>

  <!-- Chat Modal -->
  <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="chatModalLabel">Chat with {{ landlord.name }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="chatMessages" style="height:250px; overflow-y:auto; border:1px solid #eee; padding:10px; margin-bottom:10px;"></div>
          <div class="input-group">
            <input type="text" id="chatInput" class="form-control" placeholder="Type your message...">
            <button class="btn btn-primary" id="sendMsgBtn">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
function openZoom(src) {
  document.getElementById('zoomImg').src = src;
  document.getElementById('zoomModal').classList.add('active');
}
function closeZoom() {
  document.getElementById('zoomModal').classList.remove('active');
}

// Show property location on map if available
{% if property.location and property.location.latitude and property.location.longitude %}
  var map = L.map('property-map').setView(
    [{{ property.location.latitude }}, {{ property.location.longitude }}], 18
  );
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);
  L.marker([{{ property.location.latitude }}, {{ property.location.longitude }}])
    .addTo(map)
    .bindPopup("{{ property.title|e }}")
    .openPopup();
{% endif %}

const userId = {% if session['user_id'] is defined %}{{ session['user_id']|tojson }}{% else %}null{% endif %};
const landlordId = {% if landlord and landlord.id is defined %}{{ landlord.id|tojson }}{% else %}null{% endif %};
const room = (userId !== null && landlordId !== null) ? `chat_${userId}_${landlordId}` : null;
let socket;

function scrollChatToBottom() {
  const chatMessages = document.getElementById('chatMessages');
  if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
}

{% if session['role'] == 'tenant' and session['user_id'] != landlord.id %}
document.getElementById('messageLandlordBtn').addEventListener('click', function() {
  var chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
  chatModal.show();
  if (!socket && room) {
    socket = io();
    socket.emit('join_room', { room: room });
    socket.on('receive_message', function(data) {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML += `<div><b>${data.sender_id == userId ? 'You' : 'Landlord'}:</b> ${data.content} <span style='font-size:0.8em;color:#888;'>${data.timestamp}</span></div>`;
      scrollChatToBottom();
    });
  }
});
document.getElementById('sendMsgBtn').addEventListener('click', function() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (msg && socket && room) {
    socket.emit('send_message', {
      sender_id: userId,
      receiver_id: landlordId,
      content: msg,
      room: room
    });
    input.value = '';
  }
});
{% endif %}
</script>
{% endblock %}